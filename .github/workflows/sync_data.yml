name: Sync Dev Data to S3

on:
  workflow_dispatch:  # Run manually from GitHub Actions tab
  schedule:
    - cron: "0 0 * * *"  # Optional: runs daily at midnight UTC (remove if not needed)

jobs:
  sync-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

      - name: Run migrations
        env:
          DJANGO_SETTINGS_MODULE: your_project.settings  # replace with your actual settings module
        run: |
          source venv/bin/activate
          python manage.py migrate --noinput

      - name: Dump database data (dry run safe)
        env:
          DJANGO_SETTINGS_MODULE: your_project.settings
        run: |
          source venv/bin/activate
          mkdir -p dev-dumps
          timestamp=$(date +"%Y%m%d%H%M%S")
          python manage.py dumpdata --natural-primary --natural-foreign --indent 2 > dev-dumps/data_$timestamp.json

      - name: Upload dump to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-southeast-1
        run: |
          aws s3 cp dev-dumps/data_*.json s3://jiujitsuteria-mediia/dev-dumps/ --storage-class STANDARD

      - name: Keep only last 3 backups on S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-southeast-1
        run: |
          # List all dumps sorted by date (newest first)
          files=$(aws s3 ls s3://jiujitsuteria-mediia/dev-dumps/ | sort -r | awk '{print $4}')
          count=0
          for file in $files; do
            count=$((count+1))
            if [ $count -gt 3 ]; then
              echo "Deleting old backup: $file"
              aws s3 rm s3://jiujitsuteria-mediia/dev-dumps/$file
            fi
          done

      - name: Verify S3 contents
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-southeast-1
        run: |
          echo "âœ… Current backups stored in S3:"
          aws s3 ls s3://jiujitsuteria-mediia/dev-dumps/

